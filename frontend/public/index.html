<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />

    <!-- Basic SEO -->
    <title>Bolt91 — E-Bike & Accessories Rental</title>
    <meta name="description" content="Bolt91 — rent premium electric cycles and tech accessories in Goa — daily, weekly, or monthly plans." />

    <!-- PWA / icons -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />

    <!-- Content Security Policy -->
    <!--
      NOTE: This CSP is a pragmatic starting point. It allows loading scripts/styles/images from your site and common CDNs (https:).
      For strict CSP (recommended later), serve a nonce for inline scripts or move inline scripts to an external static file and reference a hash/nonce.
    -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' https:;
      script-src 'self' 'unsafe-inline' https:;
      connect-src 'self' https://us.i.posthog.com https://*.your-supabase-domain.com https://*.cloudflare.com https:;
      img-src 'self' data: https:;
      style-src 'self' 'unsafe-inline' https:;
      font-src 'self' https:;
    " />

    <!-- Load nothing dangerous by default. Analytics & recorders are loaded only after consent. -->
  </head>

  <body>
    <noscript>Please enable JavaScript to use Bolt91 — or contact us for offline booking.</noscript>

    <!-- Cookie Consent Banner -->
    <div id="cookie-consent" style="position:fixed;left:16px;right:16px;bottom:20px;z-index:10000;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.12);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
      <div style="flex:1;padding-right:12px;font-size:14px;color:#111;">
        We use analytics to improve the site. By clicking "Accept" you consent to analytics (PostHog) and optional session recording (rrweb). 
        <a href="/privacy" style="margin-left:8px;color:#0b66ff;text-decoration:underline">Privacy policy</a>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="cookie-decline" style="padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;">Decline</button>
        <button id="cookie-accept" style="padding:8px 12px;border-radius:6px;border:0;background:#0b66ff;color:#fff;">Accept</button>
      </div>
    </div>

    <!-- React root -->
    <div id="root"></div>

    <!-- Inline consent + loader script (keeps page interactive; can be externalized later) -->
    <script>
      (function () {
        const CONSENT_KEY = 'bolt91_analytics_consent'; // localStorage key

        function getConsent() {
          try {
            return JSON.parse(localStorage.getItem(CONSENT_KEY));
          } catch (e) {
            return null;
          }
        }

        function setConsent(obj) {
          try {
            localStorage.setItem(CONSENT_KEY, JSON.stringify(obj));
          } catch (e) {}
        }

        function hideBanner() {
          const el = document.getElementById('cookie-consent');
          if (el) el.style.display = 'none';
        }

        function showBannerIfNeeded() {
          const consent = getConsent();
          if (!consent) {
            const el = document.getElementById('cookie-consent');
            if (el) el.style.display = 'flex';
          } else {
            hideBanner();
            // if previously accepted, initialize analytics immediately
            if (consent.accepted) initAnalytics(consent);
          }
        }

        // Dynamic script loader
        function loadScript(src, attrs = {}) {
          return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.async = true;
            Object.keys(attrs).forEach(k => s.setAttribute(k, attrs[k]));
            s.onload = () => resolve(s);
            s.onerror = () => reject(new Error('Failed to load ' + src));
            document.head.appendChild(s);
          });
        }

        // Initialize PostHog and optional rrweb once user accepts
        async function initAnalytics(consent) {
          // POSTHOG: supply the key via build-time env replacement in CRA:
          // set REACT_APP_POSTHOG_KEY in Vercel environment variables
          const POSTHOG_KEY = '%REACT_APP_POSTHOG_KEY%'; // replace at build-time
          if (POSTHOG_KEY && consent.accepted) {
            // load PostHog script then init
            try {
              await loadScript('https://unpkg.com/posthog-js@latest/dist/posthog.umd.min.js');
              if (window.posthog) {
                window.posthog.init(POSTHOG_KEY, { api_host: 'https://us.i.posthog.com' });
                // Example: identify anonymous user by session id or your login id
                // window.posthog.identify('user_123'); 
              }
            } catch (e) {
              console.warn('PostHog load failed', e);
            }
          }

          // RRWEB (session recording) - load only if user explicitly agreed to recordings
          if (consent.recording && '%REACT_APP_ENABLE_RRWEB%' === 'true') {
            try {
              // rrweb player/recorder script (choose stable/CDN you trust)
              await loadScript('https://unpkg.com/rrweb@latest/dist/rrweb.min.js');
              await loadScript('https://d2adkz2s9zrlge.cloudfront.net/rrweb-recorder-20250919-1.js');
              // initialize rrweb recorder here if you have a recorder wrapper
              // window.rrweb && window.rrweb.record({ emit: (event) => { /* send or buffer events */ }});
            } catch (e) {
              console.warn('rrweb load failed', e);
            }
          }
        }

        // Button handlers
        document.addEventListener('DOMContentLoaded', function () {
          document.getElementById('cookie-accept').addEventListener('click', function () {
            const consent = { accepted: true, ts: Date.now(), recording: false }; // default: analytics only
            setConsent(consent);
            hideBanner();
            initAnalytics(consent);
          });

          document.getElementById('cookie-decline').addEventListener('click', function () {
            const consent = { accepted: false, ts: Date.now(), recording: false };
            setConsent(consent);
            hideBanner();
          });

          // Optionally allow users to toggle session recording via a deeper settings modal.
          showBannerIfNeeded();
        });
      })();
    </script>

    <!-- Your app bundle will be injected by the build (CRA / Vite) -->
    <!-- e.g. <script src="%PUBLIC_URL%/static/js/main.js"></script> is added automatically -->

  </body>
</html>
